<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>conferenceBuddy ‚Äî Capture & Upload</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{--bg:#0b1020;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--warn:#f59e0b;--border:#1f2937;--blue:#2563eb;--red:#ef4444;--green:#16a34a;}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter}
  .wrap{max-width:1000px;margin:auto;padding:18px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  h1{margin:0;font-size:22px}
  h2{margin:0 0 8px;font-size:16px;color:var(--muted)}
  label{display:block;margin:8px 0 6px}
  input,select,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid #263247;background:#0b1220;color:var(--ink)}
  textarea{min-height:160px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);color:var(--muted)}
  .ok{color:var(--accent)} .warn{color:var(--warn)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .bigbtn{font-size:20px;padding:20px;border-radius:14px;border:0;cursor:pointer}
  .primary{background:var(--green)} .danger{background:var(--red)} .blue{background:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .thumbWrap{position:relative}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .xbtn{position:absolute;top:6px;right:6px;background:#000a;border:0;color:#fff;border-radius:999px;width:28px;height:28px;cursor:pointer}
  .progress{height:10px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:#22c55e;width:0%}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  .iconbtn{background:transparent;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer}
  .right{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  .details{color:#cbd5e1}
  .details b{color:#e5e7eb}
  .list{display:grid;gap:8px}
  .item{padding:10px;border:1px solid var(--border);border-radius:10px;background:#0d1426;cursor:pointer}
  /* Drawers */
  .drawer{position:fixed;inset:0;background:#0008;display:none;align-items:flex-end;justify-content:flex-end}
  .sheet{width:420px;max-width:100%;background:var(--card);border-left:1px solid var(--border);height:100%;padding:16px;overflow:auto}
  .bdrawer{position:fixed;inset:0;background:#0008;display:none;align-items:flex-end;justify-content:center}
  .bsheet{width:100%;max-width:1000px;background:var(--card);border-top:1px solid var(--border);border-radius:14px 14px 0 0;padding:16px;max-height:85vh;overflow:auto}
</style>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1481.0.min.js"></script>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <h1>conferenceBuddy ‚Äî Capture & Upload</h1>
    <div class="right">
      <span id="status" class="pill">idle</span>
      <button id="settingsBtn" class="iconbtn" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- SESSION CONTROLS (Top) -->
  <div class="card">
    <h2>Session Controls</h2>

    <!-- Selection row -->
    <div class="row">
      <div>
        <label>Conference</label>
        <div class="toolbar">
          <select id="confSelect"></select>
          <button id="newConf" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
      <div>
        <label>Vendor</label>
        <div class="toolbar">
          <select id="vendorSelect"></select>
          <button id="newVendor" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Session</label>
        <div class="toolbar">
          <select id="sessSelect"></select>
          <button id="newSess" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
      <div>
        <label>Location (optional)</label>
        <input id="location" placeholder="Hall / Booth"/>
      </div>
    </div>

    <!-- Big Start/Stop -->
    <div class="toolbar" style="margin-top:8px">
      <button id="startStop" class="bigbtn primary" style="flex:1">‚óè Start Session (rec)</button>
      <button id="addImagesBtn" class="bigbtn blue" style="flex:1">üì∑ Add Image(s)</button>
      <!-- Gallery picker (multiple) -->
      <input id="imgPick" type="file" accept="image/*" multiple class="hidden">
    </div>
    <div class="pill" id="recStatus">not recording</div>
  </div>

  <!-- NOTES (center big) -->
  <div class="card">
    <h2>Notes</h2>
    <textarea id="noteText" placeholder="Type notes while recording‚Ä¶"></textarea>
    <div class="toolbar">
      <button id="addNote" class="iconbtn">Add Note</button>
      <span id="noteStatus" class="pill">0 notes</span>
    </div>
  </div>

  <!-- IMAGES -->
  <div class="card">
    <h2>Images (remove before upload if needed)</h2>
    <div id="imgGrid" class="grid"></div>
  </div>

  <!-- UPLOAD -->
  <div class="card">
    <h2>Upload</h2>
    <div class="toolbar">
      <button id="uploadAll" class="bigbtn primary" style="flex:1">‚¨ÜÔ∏è Upload Session</button>
      <span id="uploadHint" class="pill">0 items pending</span>
    </div>
    <div class="progress" style="margin-top:10px"><div id="overallBar" class="bar"></div></div>
    <div id="log" class="mono" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></div>
  </div>

  <!-- DETAILS -->
  <div class="card">
    <h2>Details</h2>
    <div class="details" id="detailsView">
      <div><b>Conference:</b> <span id="dConfName">‚Äî</span></div>
      <div><b>Vendor:</b> <span id="dVendorName">‚Äî</span></div>
      <div><b>Session:</b> <span id="dSessName">‚Äî</span></div>
      <div><b>Location:</b> <span id="dLoc">‚Äî</span></div>
      <div><b>IDs (hidden):</b> <span id="dIds" style="opacity:.6"></span></div>
    </div>
  </div>

  <!-- RECENT SESSIONS -->
  <div class="card">
    <h2>Recent Sessions</h2>
    <div id="recentList" class="list"></div>
  </div>
</div>

<!-- SETTINGS DRAWER (right) -->
<div id="drawer" class="drawer">
  <div class="sheet">
    <div class="topbar" style="margin-bottom:10px">
      <h2>S3 Settings</h2>
      <button id="closeDrawer" class="iconbtn">‚úñ</button>
    </div>
    <label>Region</label><input id="region" placeholder="eu-west-2"/>
    <label>Bucket</label><input id="bucket" placeholder="confbud"/>
    <div class="row">
      <div><label>Access Key</label><input id="ak" placeholder="AKIA‚Ä¶"/></div>
      <div><label>Secret</label><input id="sk" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="saveAws" class="bigbtn">üíæ Save</button>
      <button id="testAws" class="bigbtn">üîå Test</button>
      <span id="awsStatus" class="pill">not configured</span>
    </div>
    <small>Keys are stored in your browser only (localStorage). Configure S3 CORS for your site origin.</small>
  </div>
</div>

<!-- HISTORY BOTTOM DRAWER -->
<div id="historyDrawer" class="bdrawer">
  <div class="bsheet">
    <div class="topbar" style="margin-bottom:10px">
      <h2 id="histTitle">Session</h2>
      <button id="closeHistory" class="iconbtn">‚úñ</button>
    </div>
    <div id="histMeta" class="mono" style="white-space:pre-wrap;color:#cbd5e1;margin-bottom:10px"></div>

    <div class="card" style="margin:0 0 10px 0">
      <h2>Add More Content</h2>
      <div class="toolbar" style="margin-bottom:8px">
        <button id="histRecord" class="bigbtn primary" style="flex:1">‚óè Record Clip</button>
        <button id="histAddImages" class="bigbtn blue" style="flex:1">üì∑ Add Image(s)</button>
        <input id="histImgPick" type="file" accept="image/*" multiple class="hidden">
      </div>
      <label>Additional Notes</label>
      <textarea id="histNote" placeholder="Add notes to this session‚Ä¶"></textarea>
      <div class="toolbar" style="margin-top:8px">
        <button id="histAddNote" class="iconbtn">Add Note</button>
        <span id="histCounts" class="pill">0 new items</span>
        <button id="histUpload" class="bigbtn primary" style="margin-left:auto">‚¨ÜÔ∏è Upload to Session</button>
      </div>
      <div id="histGrid" class="grid" style="margin-top:8px"></div>
      <div id="histAudioList" class="mono" style="margin-top:8px;color:#cbd5e1"></div>
    </div>
  </div>
</div>

<script>
/* ================= Utilities ================= */
const $=s=>document.querySelector(s);
const iso=t=>new Date(t||Date.now()).toISOString().replace(/:/g,'-');
const uuid=()=>crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)});
const b2f=(blob,name)=>new File([blob],name,{type:blob.type});
const log=(...a)=>{const L=$('#log');L.textContent+=a.join(' ')+'\n';L.scrollTop=L.scrollHeight}
const setStatus=(t,cls='pill')=>{const el=$('#status');el.textContent=t;el.className=cls;}
const mimeFromName=n=>n.endsWith('.jpg')?'image/jpeg':n.endsWith('.m4a')?'audio/mp4':'text/plain';
let _lastTs=''; let _tsCount=0; const uniqTs=()=>{const t=iso(); if(t===_lastTs){_tsCount++;return `${t}__${_tsCount}`;} _lastTs=t; _tsCount=0; return t;};

// Preserve original content types & extensions
function extFromMime(mime){
  if(!mime) return '';
  const m=mime.toLowerCase();
  if(m==='image/jpeg'||m==='image/jpg')return'.jpg';
  if(m==='image/png')return'.png';
  if(m==='image/webp')return'.webp';
  if(m==='image/heic'||m==='image/heif')return'.heic';
  if(m==='image/gif')return'.gif';
  if(m==='text/plain')return'.txt';
  if(m==='audio/mp4'||m==='audio/m4a'||m==='audio/aac')return'.m4a';
  return '';
}
function nameWithOriginalExt(file, baseNoExt, fallbackExt){
  const fromMime=extFromMime(file.type);
  if(fromMime) return baseNoExt+fromMime;
  const m=/\.([a-z0-9]+)$/i.exec(file.name||'');
  if(m) return baseNoExt+'.'+m[1].toLowerCase();
  return baseNoExt+(fallbackExt||'');
}

/* ================= State ================= */
let state={
  conferences:[], vendorsByConf:{}, sessionsByConf:{},
  confId:'', vendorId:'', sessId:'',
  recording:false, rec:null, recChunks:[],
  images:[], audios:[], notes:[], uploadedKeys:new Set(),
  hist:{ sessId:'', confId:'', images:[], audios:[], notes:[], rec:null, recChunks:[] }
};

/* ================= AWS config ================= */
function loadAws(){ try{const s=JSON.parse(localStorage.cbud_aws||'{}');
  $('#region').value=s.region||'eu-west-2'; $('#bucket').value=s.bucket||'confbud'; $('#ak').value=s.ak||''; $('#sk').value=s.sk||'';
  if(s.ak&&s.sk){ $('#awsStatus').textContent='loaded'; $('#awsStatus').className='pill ok'; } else { $('#awsStatus').textContent='not configured'; $('#awsStatus').className='pill'; }
}catch{ $('#region').value='eu-west-2'; $('#bucket').value='confbud'; }}
function saveAws(){ const s={region:$('#region').value.trim()||'eu-west-2',bucket:$('#bucket').value.trim()||'confbud',ak:$('#ak').value.trim(),sk:$('#sk').value.trim()};
  localStorage.cbud_aws=JSON.stringify(s); $('#awsStatus').textContent='saved'; $('#awsStatus').className='pill ok'; }
function getAws(){ const s=JSON.parse(localStorage.cbud_aws||'{}'); if(!(s.ak&&s.sk&&s.region&&s.bucket)) return null;
  AWS.config.update({region:s.region, credentials:new AWS.Credentials(s.ak,s.sk)}); return { s3:new AWS.S3({apiVersion:'2006-03-01',params:{Bucket:s.bucket}}), bucket:s.bucket, region:s.region }; }
async function testAws(){ const cfg=getAws(); if(!cfg){$('#awsStatus').textContent='missing';$('#awsStatus').className='pill warn';return;}
  try{const Key=`cbud_test_${Date.now()}.txt`;
    await new Promise((res,rej)=>cfg.s3.upload({Bucket:cfg.bucket,Key,Body:'ok',ContentType:'text/plain'}).send((e,d)=>e?rej(e):res(d)));
    $('#awsStatus').textContent='connected'; $('#awsStatus').className='pill ok'; log('AWS test OK ‚Üí s3://'+cfg.bucket+'/'+Key);
  }catch(e){ $('#awsStatus').textContent='failed'; $('#awsStatus').className='pill warn'; log('AWS test failed:', e.code||'', e.message||e); }}

/* ================= S3 helpers ================= */
async function s3Put(Key, Body, ContentType){ const cfg=getAws(); if(!cfg) throw new Error('No AWS config'); return new Promise((res,rej)=>cfg.s3.upload({Bucket:cfg.bucket,Key,Body,ContentType}).send((e,d)=>e?rej(e):res(d))); }
async function s3GetText(Key){ const cfg=getAws(); if(!cfg) throw new Error('No AWS config'); try{ const data=await cfg.s3.getObject({Bucket:cfg.bucket,Key}).promise(); return new TextDecoder().decode(data.Body);
}catch(e){ if(e.code==='NoSuchKey') return null; throw e; } }
async function s3GetJson(Key){ const txt=await s3GetText(Key); return txt?JSON.parse(txt):null; }
async function s3PutJson(Key, obj){ return s3Put(Key, new Blob([JSON.stringify(obj)],{type:'application/json'}), 'application/json'); }

/* ================= Keys / Structure ================= */
const mKeys = {
  confIndex : ()=> `conferences/index.json`,
  vendors   : (confId)=> `conferences/${confId}/vendors.json`,
  sessIndex : (confId)=> `conferences/${confId}/sessions/index.json`,
  sessDir   : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/`,
  sessionTxt: (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/session.txt`,
  rollupTxt : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/session_${sessId}.txt`,
  indexTxt  : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/index.txt`,
  reports   : (confId)=>`conferences/${confId}/reports/`,
  audioDir  : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/audio/`,
  imageDir  : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/images/`,
  notesDir  : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/notes/`,
};

/* ================= Manifests ================= */
async function loadManifests(){
  const confs = await s3GetJson(mKeys.confIndex()) || { conferences:[] };
  state.conferences = confs.conferences;
  populateConfSelect();
  setStatus('manifests loaded','pill ok');
}
function populateConfSelect(){
  const sel=$('#confSelect'); sel.innerHTML='';
  const last = localStorage.cbud_last_conf || '';
  for(const c of state.conferences){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; if(c.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && state.conferences[0]) sel.value = state.conferences[0].id;
  onConfChange();
}
async function onConfChange(){
  const confId=$('#confSelect').value; state.confId=confId; localStorage.cbud_last_conf=confId;
  const vendors = await s3GetJson(mKeys.vendors(confId)) || { vendors:[] };
  const sessIdx = await s3GetJson(mKeys.sessIndex(confId)) || { sessions:[] };
  state.vendorsByConf[confId]=vendors.vendors;
  state.sessionsByConf[confId]=(sessIdx.sessions||[]).slice().sort((a,b)=> (b.started_at||'').localeCompare(a.started_at||''));
  populateVendorSelect(); populateSessSelect(); updateDetails(); renderRecent();
}
function populateVendorSelect(){
  const sel=$('#vendorSelect'); sel.innerHTML='';
  const last = localStorage.cbud_last_vendor || '';
  const list = state.vendorsByConf[state.confId]||[];
  for(const v of list){ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; if(v.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && list[0]) sel.value=list[0].id;
  state.vendorId = sel.value || ''; state.vendorName = (list.find(v=>v.id===state.vendorId)||{}).name || '';
}
function populateSessSelect(){
  const sel=$('#sessSelect'); sel.innerHTML='';
  const last = localStorage.cbud_last_sess || '';
  const list = state.sessionsByConf[state.confId]||[];
  for(const s of list){ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; if(s.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && list[0]) sel.value=list[0].id;
  state.sessId = sel.value || ''; const selObj=list.find(s=>s.id===state.sessId)||{};
  $('#location').value = selObj?.location || '';
  state.sessName = selObj?.name || '';
}
function renderRecent(){
  const box=$('#recentList'); box.innerHTML='';
  const list = state.sessionsByConf[state.confId]||[];
  const top = list.slice(0,8);
  for(const s of top){
    const item=document.createElement('div'); item.className='item';
    const when = s.started_at ? new Date(s.started_at).toLocaleString() : '‚Äî';
    item.innerHTML = `<b>${s.name}</b><br><small>${when}</small>`;
    item.addEventListener('click', ()=> openHistory(s));
    box.appendChild(item);
  }
}
function updateDetails(){
  const conf = state.conferences.find(c=>c.id===state.confId)||{};
  const vend = (state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId)||{};
  const sess = (state.sessionsByConf[state.confId]||[]).find(s=>s.id===state.sessId)||{};
  $('#dConfName').textContent = conf.name || '‚Äî';
  $('#dVendorName').textContent = vend.name || '‚Äî';
  $('#dSessName').textContent = sess.name || '‚Äî';
  $('#dLoc').textContent = $('#location').value || sess.location || '‚Äî';
  $('#dIds').textContent = `conf=${state.confId} ¬∑ vendor=${state.vendorId} ¬∑ session=${state.sessId}`;
}

/* ================= Ensure create in manifests (silent) ================= */
async function ensureConf(conference){
  const confs = await s3GetJson(mKeys.confIndex()) || { conferences:[] };
  if(!confs.conferences.find(c=>c.id===conference.id)){ confs.conferences.push(conference); await s3PutJson(mKeys.confIndex(), confs); }
}
async function ensureVendor(confId, vendor){
  if(!vendor?.id) return; // optional vendor
  const v = await s3GetJson(mKeys.vendors(confId)) || { vendors:[] };
  if(!v.vendors.find(x=>x.id===vendor.id)){ v.vendors.push(vendor); await s3PutJson(mKeys.vendors(confId), v); }
}
async function ensureSession(confId, session){
  const s = await s3GetJson(mKeys.sessIndex(confId)) || { sessions:[] };
  if(!s.sessions.find(x=>x.id===session.id)){ s.sessions.push(session); await s3PutJson(mKeys.sessIndex(confId), s); }
}
/* Silent context ensure: conference + session (vendor optional) */
async function ensureCurrentContext(){
  // ensure conference
  if(!state.confId){
    // default: create today's conference once
    const conf = { id: uuid(), name: `Conference ${new Date().toISOString().slice(0,10)}` };
    await ensureConf(conf);
    await loadManifests();
    $('#confSelect').value = conf.id; await onConfChange();
  }
  // ensure session
  if(!state.sessId){
    const sess = { id: uuid(), name: `Session ${new Date().toTimeString().slice(0,8)}`, vendor_id: $('#vendorSelect').value||'', started_at: new Date().toISOString(), location: $('#location').value||'' };
    await ensureSession(state.confId, sess);
    await onConfChange();
    $('#sessSelect').value = sess.id; $('#sessSelect').dispatchEvent(new Event('change'));
  }
}

/* ================= Session .txt + meta ================= */
function buildSessionTxt(confId, confName, sessId, sessName, vendorName, location){
  return [
    `conference_id: ${confId}`,
    `session_id: ${sessId}`,
    `conference_name: ${confName}`,
    `session_name: ${sessName}`,
    `vendor_name: ${vendorName||''}`,
    `started_at: ${new Date().toISOString()}`,
    `location: ${location||''}`
  ].join('\n');
}
function meta(kind,confId,sessId,name){
  return [
    `id: ${uuid()}`,
    `type: ${kind}`,
    `conference_id: ${confId}`,
    `session_id: ${sessId}`,
    `filename: ${name}`,
    `created_at: ${new Date().toISOString()}`,
    `app_version: 1`,
    `mime: ${mimeFromName(name)}`
  ].join('\n');
}

/* ================= UI: settings + selectors ================= */
$('#settingsBtn').addEventListener('click',()=>$('#drawer').style.display='flex');
$('#closeDrawer').addEventListener('click',()=>$('#drawer').style.display='none');
$('#saveAws').addEventListener('click',saveAws);
$('#testAws').addEventListener('click',testAws);

$('#confSelect').addEventListener('change', async ()=>{ await onConfChange(); updateDetails(); });
$('#vendorSelect').addEventListener('change', ()=>{ state.vendorId=$('#vendorSelect').value; localStorage.cbud_last_vendor=state.vendorId; state.vendorName=(state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId)?.name||''; updateDetails(); });
$('#sessSelect').addEventListener('change', ()=>{ state.sessId=$('#sessSelect').value; localStorage.cbud_last_sess=state.sessId; const s=(state.sessionsByConf[state.confId]||[]).find(x=>x.id===state.sessId)||{}; state.sessName=s.name||''; $('#location').value=s.location||''; updateDetails(); });

$('#newConf').addEventListener('click', async ()=>{
  const name = prompt('Conference name?'); if(!name) return;
  const c = { id: uuid(), name };
  await ensureConf(c); await loadManifests();
  $('#confSelect').value = c.id; await onConfChange(); updateDetails();
});
$('#newVendor').addEventListener('click', async ()=>{
  if(!state.confId){ alert('Pick a conference first'); return; }
  const name = prompt('Vendor name?'); if(!name) return;
  const v = { id: uuid(), name };
  await ensureVendor(state.confId, v);
  await onConfChange(); $('#vendorSelect').value = v.id; $('#vendorSelect').dispatchEvent(new Event('change'));
});
$('#newSess').addEventListener('click', async ()=>{
  if(!state.confId){ alert('Pick a conference first'); return; }
  const name = prompt('Session name?'); if(!name) return;
  const s = { id: uuid(), name, vendor_id: $('#vendorSelect').value || '', started_at: new Date().toISOString(), location: $('#location').value||'' };
  await ensureSession(state.confId, s);
  await onConfChange(); $('#sessSelect').value = s.id; $('#sessSelect').dispatchEvent(new Event('change'));
});

/* ================= Start/Stop session (audio implied, auto create) ================= */
$('#startStop').addEventListener('click', async ()=>{
  try{
    if(!state.recording){
      await ensureCurrentContext(); // silent create if needed
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      state.rec = new MediaRecorder(stream);
      state.rec.ondataavailable = e=> state.recChunks.push(e.data);
      state.rec.onstop = ()=>{
        const blob = new Blob(state.recChunks,{type:'audio/mp4'}); state.recChunks=[];
        const f=b2f(blob,'session_audio.m4a'); state.audios.push({file:f});
        const row=document.createElement('div'); row.textContent=`Session audio ${Math.round(f.size/1024)} KB @ ${new Date().toLocaleTimeString()}`;
        $('#log').appendChild(row);
        updatePending();
      };
      state.rec.start(); state.recording=true; $('#recStatus').textContent='recording‚Ä¶';
      $('#startStop').textContent='‚ñ† Stop Session'; $('#startStop').classList.remove('primary'); $('#startStop').classList.add('danger');
      setStatus('recording','pill ok');
    } else {
      state.rec.stop(); state.rec=null; state.recording=false; $('#recStatus').textContent='stopped';
      $('#startStop').textContent='‚óè Start Session (rec)'; $('#startStop').classList.remove('danger'); $('#startStop').classList.add('primary');
      setStatus('stopped','pill');
    }
  }catch(e){ alert('Mic error: '+(e.message||e)); }
});

/* ================= Images (gallery) + remove ================= */
$('#addImagesBtn').addEventListener('click',()=>$('#imgPick').click());
$('#imgPick').addEventListener('change', e=>{
  const files=[...e.target.files]; const grid=$('#imgGrid');
  files.forEach((f, i)=>{
    const idx = state.images.push({file:f})-1;
    const wrap=document.createElement('div'); wrap.className='thumbWrap'; wrap.dataset.idx=idx;
    const img=document.createElement('img'); img.className='thumb'; img.src=URL.createObjectURL(f);
    const x=document.createElement('button'); x.className='xbtn'; x.textContent='√ó';
    x.addEventListener('click',()=>{ state.images.splice(idx,1); wrap.remove(); updatePending(); });
    wrap.appendChild(img); wrap.appendChild(x); grid.appendChild(wrap);
  });
  updatePending();
});

/* ================= Notes ================= */
$('#addNote').addEventListener('click', ()=>{
  const body=$('#noteText').value.trim(); if(!body) return;
  const blob=new Blob([body],{type:'text/plain'}); const f=b2f(blob,'note.txt');
  state.notes.push({file:f, body}); $('#noteText').value=''; $('#noteStatus').textContent=`${state.notes.length} notes`; updatePending();
});

/* ================= Upload core (auto create session) ================= */
async function uploadOne(Key, File, ContentType){
  const cfg=getAws(); if(!cfg) throw new Error('No AWS config');
  return new Promise((res,rej)=>{
    const req=cfg.s3.upload({Bucket:cfg.bucket, Key, Body:File, ContentType});
    req.on('httpUploadProgress',()=>{});
    req.send((e,d)=>e?rej(e):(state.uploadedKeys.add(Key),res(d)));
  });
}
function resetAfterUpload(){
  // keep current conference selected; clear capture inputs
  state.images=[]; state.audios=[]; state.notes=[]; state.uploadedKeys=new Set();
  $('#imgGrid').innerHTML=''; $('#noteText').value=''; $('#noteStatus').textContent='0 notes';
  $('#recStatus').textContent='not recording'; $('#overallBar').style.width='0%';
  // refresh lists and recent
  onConfChange();
  // clear session selector to encourage a new auto-created session next time
  $('#sessSelect').value=''; state.sessId=''; state.sessName='';
  updateDetails();
}

/* Auto-include typed note if not added */
function maybeAutoAddCurrentNote(){
  const body = ($('#noteText')?.value || '').trim();
  if (body) {
    const blob = new Blob([body], { type: 'text/plain' });
    const f = b2f(blob, 'note.txt');
    state.notes.push({ file: f, body });
    $('#noteText').value = '';
    $('#noteStatus').textContent = `${state.notes.length} notes`;
  }
}

$('#uploadAll').addEventListener('click', async ()=>{
  try{
    setStatus('uploading‚Ä¶','pill'); $('#overallBar').style.width='0%';
    await ensureCurrentContext(); // silently ensure conf/session for this upload

    // Resolve names/ids
    const conf = state.conferences.find(c=>c.id===state.confId) || {id:state.confId, name: $('#confSelect').selectedOptions[0]?.textContent || 'Conf'};
    const vend = (state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId) || {id:state.vendorId, name: $('#vendorSelect').selectedOptions[0]?.textContent || ''};
    const sess = (state.sessionsByConf[state.confId]||[]).find(s=>s.id===state.sessId) || {id:state.sessId, name: $('#sessSelect').selectedOptions[0]?.textContent || 'Session', vendor_id: vend.id||'', location: $('#location').value||''};

    // Include any un-added note typed in textarea
    maybeAutoAddCurrentNote();

    // Ensure manifests contain current selection (no-ops if already present)
    await ensureConf({id:conf.id, name:conf.name});
    await ensureVendor(conf.id, {id:vend.id||'', name:vend.name||''});
    await ensureSession(conf.id, {id:sess.id, name:sess.name, vendor_id: sess.vendor_id||vend.id||'', started_at: sess.started_at||new Date().toISOString(), location: $('#location').value||''});

    // Scaffolding (session folder)
    await uploadOne(`${mKeys.reports(conf.id)}.keep`, new Blob([''],{type:'text/plain'}), 'text/plain');
    await uploadOne(mKeys.sessionTxt(conf.id, sess.id), new Blob([buildSessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)],{type:'text/plain'}), 'text/plain');
    await uploadOne(mKeys.rollupTxt(conf.id, sess.id), new Blob([`counts: {images:0, audio:0, notes:0}\n`+buildSessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)],{type:'text/plain'}),'text/plain');
    await uploadOne(mKeys.indexTxt(conf.id, sess.id), new Blob([''],{type:'text/plain'}),'text/plain');

    let imgN=0,audN=0,noteN=0; let total = state.images.length + state.audios.length + state.notes.length + 2; let done=0;
    const tick=()=>{ done++; $('#overallBar').style.width=Math.round(done/total*100)+'%'; };

    // IMAGES (preserve type/ext)
    for (const it of state.images) {
      try{
        const fnameBase=`${sess.id}__${uniqTs()}`;
        const name = nameWithOriginalExt(it.file, fnameBase, '.jpg');
        const ct = it.file.type || 'application/octet-stream';
        await uploadOne(mKeys.imageDir(conf.id, sess.id)+name, it.file, ct); tick();
        await uploadOne(mKeys.imageDir(conf.id, sess.id)+name+'.meta.txt', new Blob([meta('image',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
        imgN++; log('‚úÖ image uploaded:', name, 'type=', ct);
      }catch(e){ log('‚ùå image failed:', e.message||e); }
    }

    // AUDIO
    for (const it of state.audios) {
      try{
        const fnameBase=`${sess.id}__${uniqTs()}`;
        const ct = it.file.type || 'audio/mp4';
        const name = nameWithOriginalExt(it.file, fnameBase, '.m4a');
        await uploadOne(mKeys.audioDir(conf.id, sess.id)+name, it.file, ct); tick();
        await uploadOne(mKeys.audioDir(conf.id, sess.id)+name+'.meta.txt', new Blob([meta('audio',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
        audN++; log('‚úÖ audio uploaded:', name, 'type=', ct);
      }catch(e){ log('‚ùå audio failed:', e.message||e); }
    }

    // NOTES
    for (const it of state.notes) {
      try{
        const fnameBase=`${sess.id}__${uniqTs()}`;
        const name = nameWithOriginalExt(it.file, fnameBase, '.txt');
        await uploadOne(mKeys.notesDir(conf.id, sess.id)+name, it.file, 'text/plain'); tick();
        await uploadOne(mKeys.notesDir(conf.id, sess.id)+name+'.meta.txt', new Blob([meta('note',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
        noteN++; log('‚úÖ note uploaded:', name);
      }catch(e){ log('‚ùå note failed:', e.message||e); }
    }

    // update rollup & index
    const rollup=[`counts: {images:${imgN}, audio:${audN}, notes:${noteN}}`, buildSessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)].join('\n');
    await uploadOne(mKeys.rollupTxt(conf.id, sess.id), new Blob([rollup],{type:'text/plain'}),'text/plain'); tick();
    const indexText = Array.from(state.uploadedKeys).filter(k=>k.startsWith(`conferences/${conf.id}/sessions/${sess.id}/`)).join('\n');
    await uploadOne(mKeys.indexTxt(conf.id, sess.id), new Blob([indexText],{type:'text/plain'}),'text/plain'); tick();

    // refresh manifests and recent sessions
    await onConfChange(); renderRecent(); updateDetails();

    $('#uploadHint').textContent=`Uploaded ${imgN+audN+noteN} items`; $('#uploadHint').className='pill ok';
    setStatus('upload complete','pill ok');
    resetAfterUpload(); // keep conference, clear inputs
  }catch(e){
    $('#uploadHint').textContent='upload failed'; $('#uploadHint').className='pill warn';
    setStatus('upload error','pill warn'); log('Upload error:', e.message||e);
  }
});

/* ================= History (bottom drawer) ================= */
async function openHistory(s){
  const confId = state.confId;
  state.hist = { confId, sessId: s.id, images:[], audios:[], notes:[], rec:null, recChunks:[] };
  $('#histTitle').textContent = s.name || 'Session';
  const txt = await s3GetText(mKeys.sessionTxt(confId, s.id)) || '';
  const roll = await s3GetText(mKeys.rollupTxt(confId, s.id)) || '';
  $('#histMeta').textContent = (txt?txt+'\n\n':'') + (roll?roll:'');
  $('#histGrid').innerHTML=''; $('#histAudioList').innerHTML=''; $('#histNote').value=''; $('#histCounts').textContent='0 new items';
  $('#historyDrawer').style.display='flex';
}
$('#closeHistory').addEventListener('click',()=>$('#historyDrawer').style.display='none');

$('#histAddImages').addEventListener('click',()=>$('#histImgPick').click());
$('#histImgPick').addEventListener('change', e=>{
  const files=[...e.target.files]; const grid=$('#histGrid');
  files.forEach((f)=>{
    const idx = state.hist.images.push({file:f})-1;
    const wrap=document.createElement('div'); wrap.className='thumbWrap'; wrap.dataset.idx=idx;
    const img=document.createElement('img'); img.className='thumb'; img.src=URL.createObjectURL(f);
    const x=document.createElement('button'); x.className='xbtn'; x.textContent='√ó';
    x.addEventListener('click',()=>{ state.hist.images.splice(idx,1); wrap.remove(); updateHistCounts(); });
    wrap.appendChild(img); wrap.appendChild(x); grid.appendChild(wrap);
  });
  updateHistCounts();
});

$('#histRecord').addEventListener('click', async ()=>{
  try{
    if(!state.hist.rec){
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      state.hist.rec = new MediaRecorder(stream);
      state.hist.rec.ondataavailable = e=> state.hist.recChunks.push(e.data);
      state.hist.rec.onstop = ()=>{
        const blob=new Blob(state.hist.recChunks,{type:'audio/mp4'}); state.hist.recChunks=[];
        const f=b2f(blob,'clip.m4a'); state.hist.audios.push({file:f});
        const row=document.createElement('div'); row.textContent=`Clip ${Math.round(f.size/1024)} KB @ ${new Date().toLocaleTimeString()}`;
        $('#histAudioList').appendChild(row);
        updateHistCounts();
      };
      state.hist.rec.start(); $('#histRecord').textContent='‚ñ† Stop Clip'; $('#histRecord').classList.remove('primary'); $('#histRecord').classList.add('danger');
    } else {
      state.hist.rec.stop(); state.hist.rec=null; $('#histRecord').textContent='‚óè Record Clip'; $('#histRecord').classList.remove('danger'); $('#histRecord').classList.add('primary');
    }
  }catch(e){ alert('Mic error: '+(e.message||e)); }
});
$('#histAddNote').addEventListener('click', ()=>{
  const body=$('#histNote').value.trim(); if(!body) return;
  const blob=new Blob([body],{type:'text/plain'}); const f=b2f(blob,'note.txt'); state.hist.notes.push({file:f, body});
  $('#histNote').value=''; updateHistCounts();
});
function updateHistCounts(){
  const n = state.hist.images.length + state.hist.audios.length + state.hist.notes.length;
  $('#histCounts').textContent = `${n} new items`;
}

/* Upload to existing session from history drawer (with ext/mime fixes) */
$('#histUpload').addEventListener('click', async ()=>{
  const confId=state.hist.confId, sessId=state.hist.sessId;
  try{
    // include typed note if not added
    const b = ($('#histNote')?.value||'').trim();
    if(b){ const blob=new Blob([b],{type:'text/plain'}); state.hist.notes.push({file:b2f(blob,'note.txt'), body:b}); $('#histNote').value=''; }

    let imgN=0,audN=0,noteN=0; let total=state.hist.images.length+state.hist.audios.length+state.hist.notes.length+2; let done=0;
    const tick=()=>{ done++; $('#overallBar').style.width=Math.round(done/total*100)+'%'; };

    for(const it of state.hist.images){
      try{
        const fnameBase=`${sessId}__${uniqTs()}`;
        const name=nameWithOriginalExt(it.file, fnameBase, '.jpg');
        const ct=it.file.type||'application/octet-stream';
        await uploadOne(mKeys.imageDir(confId, sessId)+name, it.file, ct); tick();
        await uploadOne(mKeys.imageDir(confId, sessId)+name+'.meta.txt', new Blob([meta('image',confId,sessId,name)],{type:'text/plain'}),'text/plain'); tick();
        imgN++; log('‚úÖ image uploaded (hist):', name);
      }catch(e){ log('‚ùå image failed (hist):', e.message||e); }
    }
    for(const it of state.hist.audios){
      try{
        const fnameBase=`${sessId}__${uniqTs()}`;
        const name=nameWithOriginalExt(it.file, fnameBase, '.m4a');
        const ct=it.file.type||'audio/mp4';
        await uploadOne(mKeys.audioDir(confId, sessId)+name, it.file, ct); tick();
        await uploadOne(mKeys.audioDir(confId, sessId)+name+'.meta.txt', new Blob([meta('audio',confId,sessId,name)],{type:'text/plain'}),'text/plain'); tick();
        audN++; log('‚úÖ audio uploaded (hist):', name);
      }catch(e){ log('‚ùå audio failed (hist):', e.message||e); }
    }
    for(const it of state.hist.notes){
      try{
        const fnameBase=`${sessId}__${uniqTs()}`;
        const name=nameWithOriginalExt(it.file, fnameBase, '.txt');
        await uploadOne(mKeys.notesDir(confId, sessId)+name, it.file, 'text/plain'); tick();
        await uploadOne(mKeys.notesDir(confId, sessId)+name+'.meta.txt', new Blob([meta('note',confId,sessId,name)],{type:'text/plain'}),'text/plain'); tick();
        noteN++; log('‚úÖ note uploaded (hist):', name);
      }catch(e){ log('‚ùå note failed (hist):', e.message||e); }
    }

    // lightweight rollup delta + index update
    const rollup = `counts: {images:+${imgN}, audio:+${audN}, notes:+${noteN}}\nupdated_at: ${new Date().toISOString()}`;
    await uploadOne(mKeys.rollupTxt(confId, sessId), new Blob([rollup],{type:'text/plain'}),'text/plain'); tick();
    const indexText = Array.from(state.uploadedKeys).filter(k=>k.startsWith(`conferences/${confId}/sessions/${sessId}/`)).join('\n');
    await uploadOne(mKeys.indexTxt(confId, sessId), new Blob([indexText],{type:'text/plain'}),'text/plain'); tick();

    // clear drawer inputs
    state.hist.images=[]; state.hist.audios=[]; state.hist.notes=[]; $('#histGrid').innerHTML=''; $('#histAudioList').innerHTML=''; $('#histCounts').textContent='0 new items';
    await onConfChange(); renderRecent();
    setStatus('uploaded to session','pill ok');
  }catch(e){ setStatus('history upload error','pill warn'); log('History upload error:', e.message||e); }
});

/* ================= Pending badge ================= */
function updatePending(){ const n=state.images.length+state.audios.length+state.notes.length; $('#uploadHint').textContent=`${n} items pending`; }

/* ================= Boot ================= */
(async function boot(){
  loadAws();
  $('#drawer').style.display='none'; $('#historyDrawer').style.display='none';
  setStatus('ready','pill');
  try{
    await loadManifests();
    // If no conferences exist, silently create a default for today
    if(!state.conferences?.length){
      const conf = { id: uuid(), name: `Conference ${new Date().toISOString().slice(0,10)}` };
      await ensureConf(conf);
      await loadManifests();
      $('#confSelect').value = conf.id; await onConfChange(); updateDetails();
    }
  }catch(e){ log('Manifest load issue:', e.message||e); }
  updatePending();
})();
</script>
</body>
</html>
