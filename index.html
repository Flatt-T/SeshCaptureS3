<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>conferenceBuddy ‚Äî Capture & Upload</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{--bg:#0b1020;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--warn:#f59e0b;--border:#1f2937;--blue:#2563eb;--red:#ef4444;--green:#16a34a;}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter}
  .wrap{max-width:1000px;margin:auto;padding:18px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  h1{margin:0;font-size:22px}
  h2{margin:0 0 8px;font-size:16px;color:var(--muted)}
  label{display:block;margin:8px 0 6px}
  input,select,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid #263247;background:#0b1220;color:var(--ink)}
  textarea{min-height:160px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);color:var(--muted)}
  .ok{color:var(--accent)} .warn{color:var(--warn)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .bigbtn{font-size:20px;padding:20px;border-radius:14px;border:0;cursor:pointer}
  .primary{background:var(--green)} .danger{background:var(--red)} .blue{background:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .thumbWrap{position:relative}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .xbtn{position:absolute;top:6px;right:6px;background:#000a;border:0;color:#fff;border-radius:999px;width:28px;height:28px;cursor:pointer}
  .progress{height:10px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:#22c55e;width:0%}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  .iconbtn{background:transparent;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer}
  .right{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  .details{color:#cbd5e1}
  .details b{color:#e5e7eb}
  /* Settings drawer */
  .drawer{position:fixed;inset:0;background:#0008;display:none;align-items:flex-end;justify-content:flex-end}
  .sheet{width:420px;max-width:100%;background:var(--card);border-left:1px solid var(--border);height:100%;padding:16px;overflow:auto}
</style>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1481.0.min.js"></script>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <h1>conferenceBuddy ‚Äî Capture & Upload</h1>
    <div class="right">
      <span id="status" class="pill">idle</span>
      <button id="settingsBtn" class="iconbtn" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- SESSION CONTROLS (Top) -->
  <div class="card">
    <h2>Session Controls</h2>

    <!-- Selection row -->
    <div class="row">
      <div>
        <label>Conference</label>
        <div class="toolbar">
          <select id="confSelect"></select>
          <button id="newConf" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
      <div>
        <label>Vendor</label>
        <div class="toolbar">
          <select id="vendorSelect"></select>
          <button id="newVendor" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Session</label>
        <div class="toolbar">
          <select id="sessSelect"></select>
          <button id="newSess" class="iconbtn">New‚Ä¶</button>
        </div>
      </div>
      <div>
        <label>Location (optional)</label>
        <input id="location" placeholder="Hall / Booth"/>
      </div>
    </div>

    <!-- Big Start/Stop -->
    <div class="toolbar" style="margin-top:8px">
      <button id="startStop" class="bigbtn primary" style="flex:1">‚óè Start Session (rec)</button>
      <button id="addImagesBtn" class="bigbtn blue" style="flex:1">üì∑ Add Image(s)</button>
      <input id="imgPick" type="file" accept="image/*" capture="environment" multiple class="hidden">
    </div>
    <div class="pill" id="recStatus">not recording</div>
  </div>

  <!-- NOTES (center big) -->
  <div class="card">
    <h2>Notes</h2>
    <textarea id="noteText" placeholder="Type notes while recording‚Ä¶"></textarea>
    <div class="toolbar">
      <button id="addNote" class="iconbtn">Add Note</button>
      <span id="noteStatus" class="pill">0 notes</span>
    </div>
  </div>

  <!-- IMAGES -->
  <div class="card">
    <h2>Images (remove before upload if needed)</h2>
    <div id="imgGrid" class="grid"></div>
  </div>

  <!-- UPLOAD -->
  <div class="card">
    <h2>Upload</h2>
    <div class="toolbar">
      <button id="uploadAll" class="bigbtn primary" style="flex:1">‚¨ÜÔ∏è Upload Session</button>
      <span id="uploadHint" class="pill">0 items pending</span>
    </div>
    <div class="progress" style="margin-top:10px"><div id="overallBar" class="bar"></div></div>
    <div id="log" class="mono" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></div>
  </div>

  <!-- DETAILS -->
  <div class="card">
    <h2>Details</h2>
    <div class="details" id="detailsView">
      <div><b>Conference:</b> <span id="dConfName">‚Äî</span></div>
      <div><b>Vendor:</b> <span id="dVendorName">‚Äî</span></div>
      <div><b>Session:</b> <span id="dSessName">‚Äî</span></div>
      <div><b>Location:</b> <span id="dLoc">‚Äî</span></div>
      <div><b>IDs (hidden):</b> <span id="dIds" style="opacity:.6"></span></div>
    </div>
  </div>
</div>

<!-- SETTINGS DRAWER -->
<div id="drawer" class="drawer">
  <div class="sheet">
    <div class="topbar" style="margin-bottom:10px">
      <h2>S3 Settings</h2>
      <button id="closeDrawer" class="iconbtn">‚úñ</button>
    </div>
    <label>Region</label><input id="region" placeholder="eu-west-2"/>
    <label>Bucket</label><input id="bucket" placeholder="confbud"/>
    <div class="row">
      <div><label>Access Key</label><input id="ak" placeholder="AKIA‚Ä¶"/></div>
      <div><label>Secret</label><input id="sk" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="saveAws" class="bigbtn">üíæ Save</button>
      <button id="testAws" class="bigbtn">üîå Test</button>
      <span id="awsStatus" class="pill">not configured</span>
    </div>
    <small>Keys are stored in your browser only (localStorage). You need bucket CORS to allow your site origin for GET/PUT/HEAD.</small>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const $=s=>document.querySelector(s);
const iso=t=>new Date(t||Date.now()).toISOString().replace(/:/g,'-');
const uuid=()=>crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)});
const b2f=(blob,name)=>new File([blob],name,{type:blob.type});
const log=(...a)=>{const L=$('#log');L.textContent+=a.join(' ')+'\n';L.scrollTop=L.scrollHeight}
const setStatus = (t, cls='pill')=>{ const el=$('#status'); el.textContent=t; el.className=cls; }
const mimeFromName=n=>n.endsWith('.jpg')?'image/jpeg':n.endsWith('.m4a')?'audio/mp4':'text/plain';

/* De-collision for timestamped names */
let _lastTs=''; let _tsCount=0;
function uniqTs(){ const t=iso(); if(t===_lastTs){_tsCount++; return `${t}__${_tsCount}`;} _lastTs=t; _tsCount=0; return t; }

/* ===== In-memory session ===== */
let state={
  conferences:[], vendorsByConf:{}, sessionsByConf:{}, // from manifests
  confId:'', vendorId:'', sessId:'',
  confName:'', vendorName:'', sessName:'', location:'',
  recording:false, rec:null, recChunks:[],
  images:[], audios:[], notes:[], uploadedKeys:new Set()
};

/* ===== AWS settings ===== */
function loadAws(){
  try{const s=JSON.parse(localStorage.cbud_aws||'{}');
    $('#region').value=s.region||'eu-west-2'; $('#bucket').value=s.bucket||'confbud'; $('#ak').value=s.ak||''; $('#sk').value=s.sk||'';
    if(s.ak&&s.sk){ $('#awsStatus').textContent='loaded'; $('#awsStatus').className='pill ok'; } else { $('#awsStatus').textContent='not configured'; $('#awsStatus').className='pill'; }
  }catch{ $('#region').value='eu-west-2'; $('#bucket').value='confbud'; }
}
function saveAws(){
  const s={region:$('#region').value.trim()||'eu-west-2',bucket:$('#bucket').value.trim()||'confbud',ak:$('#ak').value.trim(),sk:$('#sk').value.trim()};
  localStorage.cbud_aws=JSON.stringify(s); $('#awsStatus').textContent='saved'; $('#awsStatus').className='pill ok';
}
function getAws(){
  const s=JSON.parse(localStorage.cbud_aws||'{}'); if(!(s.ak&&s.sk&&s.region&&s.bucket)) return null;
  AWS.config.update({region:s.region, credentials:new AWS.Credentials(s.ak,s.sk)});
  return { s3:new AWS.S3({apiVersion:'2006-03-01',params:{Bucket:s.bucket}}), bucket:s.bucket, region:s.region };
}
async function testAws(){
  const cfg=getAws(); if(!cfg){$('#awsStatus').textContent='missing';$('#awsStatus').className='pill warn';return;}
  try{
    const Key=`cbud_test_${Date.now()}.txt`;
    await new Promise((res,rej)=>cfg.s3.upload({Bucket:cfg.bucket,Key,Body:'ok',ContentType:'text/plain'}).send((e,d)=>e?rej(e):res(d)));
    $('#awsStatus').textContent='connected'; $('#awsStatus').className='pill ok'; log('AWS test OK ‚Üí s3://'+cfg.bucket+'/'+Key);
  }catch(e){ $('#awsStatus').textContent='failed'; $('#awsStatus').className='pill warn'; log('AWS test failed:', e.code||'', e.message||e); }
}

/* ===== S3 helpers (JSON + text) ===== */
async function s3Put(Key, Body, ContentType){ const cfg=getAws(); if(!cfg) throw new Error('No AWS config'); return new Promise((res,rej)=>cfg.s3.upload({Bucket:cfg.bucket,Key,Body,ContentType}).send((e,d)=>e?rej(e):res(d))); }
async function s3GetText(Key){ const cfg=getAws(); if(!cfg) throw new Error('No AWS config'); try{
  const data=await cfg.s3.getObject({Bucket:cfg.bucket,Key}).promise(); return new TextDecoder().decode(data.Body);
}catch(e){ if(e.code==='NoSuchKey') return null; throw e; } }
async function s3GetJson(Key){ const txt=await s3GetText(Key); return txt?JSON.parse(txt):null; }
async function s3PutJson(Key, obj){ return s3Put(Key, new Blob([JSON.stringify(obj)],{type:'application/json'}), 'application/json'); }
async function s3PutTxt(Key, txt){ return s3Put(Key, new Blob([txt],{type:'text/plain'}), 'text/plain'); }

/* ===== Manifest keys ===== */
const mKeys = {
  confIndex : ()=> `conferences/index.json`,
  vendors   : (confId)=> `conferences/${confId}/vendors.json`,
  sessIndex : (confId)=> `conferences/${confId}/sessions/index.json`,
  // existing text files
  sessionTxt: (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/session.txt`,
  rollupTxt : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/session_${sessId}.txt`,
  sessDir   : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/`,
  reports   : (confId)=>`conferences/${confId}/reports/`,
  audioDir  : (confId)=>`conferences/${confId}/audio/`,
  imageDir  : (confId)=>`conferences/${confId}/images/`,
  notesDir  : (confId)=>`conferences/${confId}/notes/`,
  indexTxt  : (confId,sessId)=>`conferences/${confId}/sessions/${sessId}/index.txt`,
};

/* ===== Manifest load/populate UI ===== */
async function loadManifests(){
  try{
    const confs = await s3GetJson(mKeys.confIndex()) || { conferences:[] };
    state.conferences = confs.conferences;
    populateConfSelect();
    setStatus('manifests loaded','pill ok');
  }catch(e){ log('Load manifests failed:', e.message||e); setStatus('manifest load error','pill warn'); }
}
function populateConfSelect(){
  const sel=$('#confSelect'); sel.innerHTML='';
  const last = localStorage.cbud_last_conf || '';
  for(const c of state.conferences){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; if(c.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && state.conferences[0]) sel.value = state.conferences[0].id;
  onConfChange();
}
async function onConfChange(){
  const confId=$('#confSelect').value; state.confId=confId; localStorage.cbud_last_conf=confId;
  // load vendors & sessions
  const vendors = await s3GetJson(mKeys.vendors(confId)) || { vendors:[] };
  const sessIdx = await s3GetJson(mKeys.sessIndex(confId)) || { sessions:[] };
  state.vendorsByConf[confId]=vendors.vendors; state.sessionsByConf[confId]=sessIdx.sessions;
  populateVendorSelect(); populateSessSelect(); updateDetails();
}
function populateVendorSelect(){
  const sel=$('#vendorSelect'); sel.innerHTML=''; const confId=state.confId;
  const last = localStorage.cbud_last_vendor || '';
  const list = state.vendorsByConf[confId]||[];
  for(const v of list){ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; if(v.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && list[0]) sel.value=list[0].id;
  state.vendorId = sel.value || ''; state.vendorName = (list.find(v=>v.id===state.vendorId)||{}).name || '';
}
function populateSessSelect(){
  const sel=$('#sessSelect'); sel.innerHTML=''; const confId=state.confId;
  const last = localStorage.cbud_last_sess || '';
  const list = (state.sessionsByConf[confId]||[]).sort((a,b)=> (b.started_at||'').localeCompare(a.started_at||''));
  for(const s of list){ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; if(s.id===last) o.selected=true; sel.appendChild(o); }
  if(!sel.value && list[0]) sel.value=list[0].id;
  state.sessId = sel.value || ''; const selObj=list.find(s=>s.id===state.sessId)||{};
  state.sessName = selObj.name || ''; $('#location').value = selObj.location || '';
}
function updateDetails(){
  const conf = state.conferences.find(c=>c.id===state.confId)||{};
  const vend = (state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId)||{};
  const sess = (state.sessionsByConf[state.confId]||[]).find(s=>s.id===state.sessId)||{};
  $('#dConfName').textContent = conf.name || '‚Äî';
  $('#dVendorName').textContent = vend.name || '‚Äî';
  $('#dSessName').textContent = sess.name || '‚Äî';
  $('#dLoc').textContent = $('#location').value || sess.location || '‚Äî';
  $('#dIds').textContent = `conf=${state.confId} ¬∑ vendor=${state.vendorId} ¬∑ session=${state.sessId}`;
}

/* ===== Create new Conference/Vendor/Session ===== */
async function ensureConf(conference){
  // conference: {id,name,start?,end?}
  const confs = await s3GetJson(mKeys.confIndex()) || { conferences:[] };
  if(!confs.conferences.find(c=>c.id===conference.id)){ confs.conferences.push(conference); await s3PutJson(mKeys.confIndex(), confs); }
}
async function ensureVendor(confId, vendor){
  const v = await s3GetJson(mKeys.vendors(confId)) || { vendors:[] };
  if(!v.vendors.find(x=>x.id===vendor.id)){ v.vendors.push(vendor); await s3PutJson(mKeys.vendors(confId), v); }
}
async function ensureSession(confId, session){
  const s = await s3GetJson(mKeys.sessIndex(confId)) || { sessions:[] };
  if(!s.sessions.find(x=>x.id===session.id)){ s.sessions.push(session); await s3PutJson(mKeys.sessIndex(confId), s); }
}

/* ===== Session text + meta builders (existing .txt structure) ===== */
function sessionTxt(confId, confName, sessId, sessName, vendorName, location){
  return [
    `conference_id: ${confId}`,
    `session_id: ${sessId}`,
    `conference_name: ${confName}`,
    `session_name: ${sessName}`,
    `vendor_name: ${vendorName||''}`,
    `started_at: ${new Date().toISOString()}`,
    `location: ${location||''}`
  ].join('\n');
}
function meta(kind,confId,sessId,name){
  return [
    `id: ${uuid()}`,
    `type: ${kind}`,
    `conference_id: ${confId}`,
    `session_id: ${sessId}`,
    `filename: ${name}`,
    `created_at: ${new Date().toISOString()}`,
    `app_version: 1`,
    `mime: ${mimeFromName(name)}`
  ].join('\n');
}

/* ===== UI wiring ===== */
$('#settingsBtn').addEventListener('click',()=>$('#drawer').style.display='flex');
$('#closeDrawer').addEventListener('click',()=>$('#drawer').style.display='none');
$('#saveAws').addEventListener('click',()=>{ saveAws(); });
$('#testAws').addEventListener('click',()=>{ testAws(); });

$('#confSelect').addEventListener('change', async ()=>{ await onConfChange(); updateDetails(); });
$('#vendorSelect').addEventListener('change', ()=>{ state.vendorId=$('#vendorSelect').value; localStorage.cbud_last_vendor=state.vendorId; state.vendorName=(state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId)?.name||''; updateDetails(); });
$('#sessSelect').addEventListener('change', ()=>{ state.sessId=$('#sessSelect').value; localStorage.cbud_last_sess=state.sessId; const s=(state.sessionsByConf[state.confId]||[]).find(x=>x.id===state.sessId)||{}; state.sessName=s.name||''; $('#location').value=s.location||''; updateDetails(); });

$('#newConf').addEventListener('click', async ()=>{
  const name = prompt('Conference name?'); if(!name) return;
  const c = { id: uuid(), name };
  await ensureConf(c); await loadManifests();
  $('#confSelect').value = c.id; await onConfChange(); updateDetails();
});

$('#newVendor').addEventListener('click', async ()=>{
  if(!state.confId){ alert('Pick a conference first'); return; }
  const name = prompt('Vendor name?'); if(!name) return;
  const v = { id: uuid(), name };
  await ensureVendor(state.confId, v);
  await onConfChange(); // reload vendors/sessions
  $('#vendorSelect').value = v.id; $('#vendorSelect').dispatchEvent(new Event('change'));
});

$('#newSess').addEventListener('click', async ()=>{
  if(!state.confId){ alert('Pick a conference first'); return; }
  const name = prompt('Session name?'); if(!name) return;
  const s = { id: uuid(), name, vendor_id: $('#vendorSelect').value || '', started_at: new Date().toISOString(), location: $('#location').value||'' };
  await ensureSession(state.confId, s);
  await onConfChange(); // refresh lists
  $('#sessSelect').value = s.id; $('#sessSelect').dispatchEvent(new Event('change'));
});

/* Start/Stop session (audio recording implied) */
$('#startStop').addEventListener('click', async ()=>{
  try{
    if(!state.recording){
      // ensure required fields are present; auto-fill if missing
      if(!state.confId && state.conferences.length===0){
        // create a default conf
        const c = {id: uuid(), name: `Conference ${new Date().toISOString().slice(0,10)}`};
        await ensureConf(c); await loadManifests(); $('#confSelect').value=c.id; await onConfChange();
      }
      if(!state.sessId){
        const s = { id: uuid(), name: `Session ${new Date().toTimeString().slice(0,8)}`, vendor_id: $('#vendorSelect').value||'', started_at: new Date().toISOString(), location: $('#location').value||'' };
        await ensureSession($('#confSelect').value, s);
        await onConfChange();
        $('#sessSelect').value=s.id; $('#sessSelect').dispatchEvent(new Event('change'));
      }
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      state.rec = new MediaRecorder(stream);
      state.rec.ondataavailable = e=> state.recChunks.push(e.data);
      state.rec.onstop = ()=>{
        const blob = new Blob(state.recChunks,{type:'audio/mp4'}); state.recChunks=[];
        const f=b2f(blob,'session_audio.m4a'); state.audios.push({file:f});
        const row=document.createElement('div'); row.textContent=`Session audio ${Math.round(f.size/1024)} KB @ ${new Date().toLocaleTimeString()}`;
        $('#log').appendChild(row);
      };
      state.rec.start(); state.recording=true; $('#recStatus').textContent='recording‚Ä¶';
      $('#startStop').textContent='‚ñ† Stop Session'; $('#startStop').classList.remove('primary'); $('#startStop').classList.add('danger');
      setStatus('recording','pill ok');
    } else {
      state.rec.stop(); state.rec=null; state.recording=false; $('#recStatus').textContent='stopped';
      $('#startStop').textContent='‚óè Start Session (rec)'; $('#startStop').classList.remove('danger'); $('#startStop').classList.add('primary');
      setStatus('stopped','pill');
    }
  }catch(e){ alert('Mic error: '+(e.message||e)); }
});

/* Images add/remove */
$('#addImagesBtn').addEventListener('click',()=>$('#imgPick').click());
$('#imgPick').addEventListener('change', e=>{
  const files=[...e.target.files]; const grid=$('#imgGrid');
  files.forEach((f,i)=>{
    const idx = state.images.push({file:f})-1;
    const wrap=document.createElement('div'); wrap.className='thumbWrap'; wrap.dataset.idx=idx;
    const img=document.createElement('img'); img.className='thumb'; img.src=URL.createObjectURL(f);
    const x=document.createElement('button'); x.className='xbtn'; x.textContent='√ó';
    x.addEventListener('click',()=>{ state.images.splice(idx,1); wrap.remove(); updatePending(); });
    wrap.appendChild(img); wrap.appendChild(x); grid.appendChild(wrap);
  });
  updatePending();
});

/* Notes */
$('#addNote').addEventListener('click', ()=>{
  const body=$('#noteText').value.trim(); if(!body) return;
  const blob=new Blob([body],{type:'text/plain'}); const f=b2f(blob,'note.txt');
  state.notes.push({file:f, body}); $('#noteText').value=''; $('#noteStatus').textContent=`${state.notes.length} notes`; updatePending();
});

/* Upload */
async function uploadOne(Key, File, ContentType){
  const cfg=getAws(); if(!cfg) throw new Error('No AWS config');
  return new Promise((res,rej)=>{
    const req=cfg.s3.upload({Bucket:cfg.bucket, Key, Body:File, ContentType});
    req.on('httpUploadProgress',e=>{
      // per-file progress (aggregate is handled by tick)
    });
    req.send((e,d)=>e?rej(e):(state.uploadedKeys.add(Key),res(d)));
  });
}
$('#uploadAll').addEventListener('click', async ()=>{
  try{
    setStatus('uploading‚Ä¶','pill'); $('#overallBar').style.width='0%';
    // re-resolve names and IDs
    const conf = state.conferences.find(c=>c.id===state.confId) || {id:state.confId, name: $('#confSelect').selectedOptions[0]?.textContent || 'Conf'};
    const vend = (state.vendorsByConf[state.confId]||[]).find(v=>v.id===state.vendorId) || {id:state.vendorId, name: $('#vendorSelect').selectedOptions[0]?.textContent || ''};
    const sess = (state.sessionsByConf[state.confId]||[]).find(s=>s.id===state.sessId) || {id:state.sessId, name: $('#sessSelect').selectedOptions[0]?.textContent || 'Session', vendor_id: vend.id||'', location: $('#location').value||''};

    // ensure manifests contain selections (in case of fresh IDs)
    await ensureConf({id:conf.id, name:conf.name});
    await ensureVendor(conf.id, {id:vend.id||'', name:vend.name||''});
    await ensureSession(conf.id, {id:sess.id, name:sess.name, vendor_id: sess.vendor_id||vend.id||'', started_at: sess.started_at||new Date().toISOString(), location: $('#location').value||''});

    // session scaffolding
    await uploadOne(`${mKeys.reports(conf.id)}.keep`, new Blob([''],{type:'text/plain'}), 'text/plain');
    await uploadOne(mKeys.sessionTxt(conf.id, sess.id), new Blob([sessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)],{type:'text/plain'}), 'text/plain');
    await uploadOne(mKeys.rollupTxt(conf.id, sess.id), new Blob([`counts: {images:0, audio:0, notes:0}\n`+sessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)],{type:'text/plain'}),'text/plain');
    await uploadOne(mKeys.indexTxt(conf.id, sess.id), new Blob([''],{type:'text/plain'}),'text/plain');

    // totals
    let imgN=0,audN=0,noteN=0;
    let total = state.images.length + state.audios.length + state.notes.length + 2; // + rollup/index update
    let done = 0; const tick=()=>{ done++; const pct=Math.round(done/total*100); $('#overallBar').style.width=pct+'%'; };

    // images
    for(const it of state.images){
      const name = `${sess.id}__${uniqTs()}.jpg`;
      await uploadOne(mKeys.imageDir(conf.id)+name, it.file, 'image/jpeg'); tick();
      await uploadOne(mKeys.imageDir(conf.id)+name.replace(/\.jpg$/,'.meta.txt'), new Blob([meta('image',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
      imgN++;
    }
    // audios
    for(const it of state.audios){
      const name = `${sess.id}__${uniqTs()}.m4a`;
      await uploadOne(mKeys.audioDir(conf.id)+name, it.file, 'audio/mp4'); tick();
      await uploadOne(mKeys.audioDir(conf.id)+name.replace(/\.m4a$/,'.meta.txt'), new Blob([meta('audio',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
      audN++;
    }
    // notes
    for(const it of state.notes){
      const name = `${sess.id}__${uniqTs()}.txt`;
      await uploadOne(mKeys.notesDir(conf.id)+name, it.file, 'text/plain'); tick();
      await uploadOne(mKeys.notesDir(conf.id)+name.replace(/\.txt$/,'.meta.txt'), new Blob([meta('note',conf.id,sess.id,name)],{type:'text/plain'}),'text/plain'); tick();
      noteN++;
    }

    // update rollup & index
    const rollup=[`counts: {images:${imgN}, audio:${audN}, notes:${noteN}}`, sessionTxt(conf.id, conf.name, sess.id, sess.name, vend.name, $('#location').value)].join('\n');
    await uploadOne(mKeys.rollupTxt(conf.id, sess.id), new Blob([rollup],{type:'text/plain'}),'text/plain'); tick();
    const indexText = Array.from(state.uploadedKeys).filter(k=>k.startsWith(`conferences/${conf.id}/`)).join('\n');
    await uploadOne(mKeys.indexTxt(conf.id, sess.id), new Blob([indexText],{type:'text/plain'}),'text/plain'); tick();

    // refresh manifests (to include the new session if it was created just now)
    await onConfChange(); updateDetails();

    $('#uploadHint').textContent=`Uploaded ${imgN+audN+noteN} items`; $('#uploadHint').className='pill ok';
    setStatus('upload complete','pill ok');
  }catch(e){
    $('#uploadHint').textContent='upload failed'; $('#uploadHint').className='pill warn';
    setStatus('upload error','pill warn'); log('Upload error:', e.message||e);
  }
});

/* ===== Pending counter ===== */
function updatePending(){ const n=state.images.length+state.audios.length+state.notes.length; $('#uploadHint').textContent=`${n} items pending`; }

/* ===== Boot ===== */
(async function boot(){
  loadAws(); // settings
  $('#drawer').style.display='none';
  setStatus('ready','pill');
  try{
    await loadManifests();
  }catch{}
  updatePending();
})();
</script>
</body>
</html>
